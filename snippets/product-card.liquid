{%- assign button_id = 'btn-add-to-cart-' | append: product.id -%}

<div class="product-card-container flex flex-1 h-full" data-product-id="{{ product.id }}">
  <div class="group product-card bg-card rounded-lg overflow-hidden border border-foreground/10 flex flex-col flex-1">
    <a href="{{ product.url }}" class="image-wrapper overflow-hidden aspect-square relative">
      <div class="badge-container absolute top-3 right-3 flex gap-2 items-center justify-end z-1">
        {%- render 'disc-badge', finalPrice: product.price, price: product.compare_at_price -%}
      </div>
      <picture>
        <source media="(min-width: 768px)" srcset="{{ product.featured_image | image_url: height: 250 }}">
        <source media="(min-width: 1180px)" srcset="{{ product.featured_image | image_url: height: 300 }}">
        <img
          src="{{ product.featured_image | image_url: height: 150 }}"
          width="150"
          height="150"
          class="w-full aspect-square object-cover transition-all duration-200 ease-linear group-hover:scale-[1.1] group-hover:rotate-1"
          alt="{{ product.title }}"
          loading="lazy"
        >
      </picture>
    </a>
    <div class="p-4 flex flex-col !justify-between flex-1">
      <a href="{{ product.url }}">
        <p class="font-medium !mb-1 text-sm md:text-base">{{ product.title }}</p>
        {%- render 'price', finalPrice: product.price, price: product.compare_at_price -%}
      </a>

      {% if product.options.first == 'Title' %}
        <input type="radio" name="variant-{{ product.id }}" value="{{ product.variants.first.id }}" checked hidden>
      {% else %}
        {%- for option in product.options -%}
          <div class="!mt-2 relative">
            <p class="text-sm !mb-1 font-medium">{{ option }}:</p>
            <div class="variant-wrapper flex gap-2 whitespace-nowrap overflow-x-auto">
              {% for variant in product.variants %}
                <label class="variant-selector">
                  <input
                    type="radio"
                    name="variant-{{ product.id }}"
                    value="{{ variant.id }}"
                    class="sr-only"
                  />
                  <span class="text-sm">{{ variant.title }}</span>
                </label>
              {% endfor %}
            </div>
            <p
              class="error-variant absolute bottom-[70%] bg-red-500 text-white text-sm py-1 px-2 rounded-sm
                hidden opacity-0 items-center justify-start gap-2 before:absolute before:top-[100%] before:w-0 before:h-0
                before:border-6 before:border-transparent before:border-t-red-500 z-2 transition-all duration-150"
            >
              {%- render 'icon-warning-comment', size: 18 -%}
              Please select a variant
            </p>
          </div>
        {%- endfor -%}
      {% endif %}

      <div class="!mt-4">
        <button
          type="button"
          id="{{ button_id }}"
          class="btn-add-to-cart py-2 px-8 w-full bg-primary text-white font-medium hover:bg-primary/90
            rounded-md flex items-center justify-center gap-2 disabled:bg-primary/50 disabled:!cursor-default"
          aria-label="Add to Cart"
          data-product-id={{ product.id }}
          data-has-single-variant="{% if product.options.first == 'Title' %}true{% else %}false{% endif %}"
        >
          {%- render 'icon-cart', size: 18 -%}
          <span>Add<span class="hidden md:inline"> to Cart</span></span>
        </button>
      </div>
    </div>
  </div>
</div>

{% javascript %}
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-add-to-cart').forEach(button => {
      button.addEventListener('click', function () {
        const productId = this.dataset.productId;
        const hasSingleVariant = this.dataset.hasSingleVariant === 'true';

        let selectedVariant = document.querySelector(`input[name="variant-${productId}"]:checked`);

        if (hasSingleVariant && !selectedVariant) {
          selectedVariant = document.querySelector(`input[name="variant-${productId}"]`);
        }

        if (!selectedVariant) {
          const errorEl = button.parentElement.parentElement.querySelector('.error-variant');
          
          errorEl.classList.remove('hidden');
          errorEl.classList.add('flex');
          setTimeout(() => {
            errorEl.classList.remove('opacity-0');
            errorEl.classList.add('opacity-100');
          }, 100);

          setTimeout(() => {
            errorEl.classList.remove('opacity-100');
            errorEl.classList.add('opacity-0');
          }, 2000);
          setTimeout(() => {
            errorEl.classList.remove('flex');
            errorEl.classList.add('hidden');
          }, 2100);
          return;
        } else {
          const variantId = selectedVariant.value;
          this.disabled = true;
          this.querySelector('span').innerHTML = 'Adding';
  
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              id: variantId,
              quantity: 1
            })
          })
            .then(res => res.json())
            .then(data => {
              // Optional: update cart icon, show toast, etc.
              setTimeout(() => {
                this.querySelector('span').innerHTML = "Added";
                this.disabled = false;
                setTimeout(() => {
                  this.querySelector('span').innerHTML = "Add to Cart";
                }, 1000);
              }, 1000);
              return fetch('/cart.js');
            })
            .then(response => response.json())
            .then(cart => {
              document.getElementById('cart-item-count').textContent = cart.item_count <= 9 ? cart.item_count : "9+";
            })
            .catch(err => {
              console.error('Add to cart error:', err);
              setTimeout(() => {
                this.querySelector('span').innerHTML = "Failed :(";
                this.disabled = false;
                setTimeout(() => {
                  this.querySelector('span').innerHTML = "Add to Cart";
                }, 1000);
              }, 1000);
            });
        }
      });
    });
  }); 
{% endjavascript %}
